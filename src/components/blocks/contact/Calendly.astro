---
// Calendly Widget
// ------------
// Description: Embedded Calendly booking widget

// Components
// - Layout
import Section from '../../ui/Section.astro'
import Row from '../../ui/Row.astro'
import Col from '../../ui/Col.astro'

// Props
type Props = {
	classes?: string
	url?: string
}
const { classes, url = 'https://calendly.com/ben-horton-finance-janet/30min' } = Astro.props
---

<Section id="book-lesson" classes={classes}>
	<Row>
		<Col span="12" align="center" classes="mb-8">
			<h2 class="text-balance">Book Your <strong>Free Intro Call</strong></h2>
			<p class="pb-0 text-lg max-w-3xl mx-auto">
				Free intro call, no commitment. Select a time that works for you.
			</p>
		</Col>
	</Row>
	<Row>
		<Col span="12">
			<!-- Calendly inline widget begin -->
			<div
				class="calendly-inline-widget"
				data-url={url}
				style="min-width:320px;height:700px;"
			></div>
			<!-- Calendly inline widget end -->
		</Col>
	</Row>
</Section>

<script define:vars={{url}}>
   function loadCalendlyScript(callback) {
	   if (window.Calendly) {
		   callback();
		   return;
	   }
	   const existingScript = document.querySelector('script[src="https://assets.calendly.com/assets/external/widget.js"]');
	   if (existingScript) {
		   existingScript.addEventListener('load', callback);
		   return;
	   }
	   const script = document.createElement('script');
	   script.src = 'https://assets.calendly.com/assets/external/widget.js';
	   script.async = true;
	   script.onload = callback;
	   document.head.appendChild(script);
   }

   function initCalendly() {
	   if (!window.Calendly) {
		   // Try again after script loads
		   setTimeout(initCalendly, 100);
		   return;
	   }
	   // Remove any existing Calendly widget iframe(s) before initializing
	   const parent = document.querySelector('.calendly-inline-widget');
	   if (parent) {
		   // Remove all iframes inside the widget container
		   Array.from(parent.querySelectorAll('iframe')).forEach((iframe) => iframe.remove());
	   }
	   window.Calendly.initInlineWidget({
		   url: url,
		   parentElement: parent
	   });
   }

   function setupCalendly() {
	   loadCalendlyScript(initCalendly);
   }

   if (document.readyState === 'loading') {
	   document.addEventListener('DOMContentLoaded', setupCalendly);
   } else {
	   setupCalendly();
   }
   document.addEventListener('astro:after-swap', setupCalendly);
</script>

<style>
	.calendly-inline-widget {
		position: relative;
		width: 100%;
	}
</style>
